/**
 * Script pour générer un index de tous les fichiers CVE disponibles
 * Usage: node generate-cve-index.js
 */

const fs = require('fs');
const path = require('path');

const CVES_DIR = path.join(__dirname, 'cves', '2025');
const INDEX_FILE = path.join(__dirname, 'cves', '2025', 'index.json');

/**
 * Liste récursivement tous les fichiers JSON dans un dossier
 */
function listCveFiles(dirPath) {
    const cveFiles = [];
    
    try {
        const entries = fs.readdirSync(dirPath, { withFileTypes: true });
        
        for (const entry of entries) {
            const fullPath = path.join(dirPath, entry.name);
            
            if (entry.isDirectory()) {
                // Parcourir récursivement les sous-dossiers
                const subFiles = listCveFiles(fullPath);
                cveFiles.push(...subFiles);
            } else if (entry.isFile() && entry.name.endsWith('.json') && entry.name.startsWith('CVE-2025-')) {
                // Ajouter le fichier CVE
                const relativePath = path.relative(CVES_DIR, fullPath);
                cveFiles.push({
                    cveId: entry.name.replace('.json', ''),
                    path: relativePath.replace(/\\/g, '/'), // Normaliser les séparateurs
                    fullPath: fullPath
                });
            }
        }
    } catch (error) {
        console.error(`Erreur lors de la lecture de ${dirPath}:`, error.message);
    }
    
    return cveFiles;
}

/**
 * Génère l'index des CVE
 */
function generateIndex() {
    console.log('Scan des fichiers CVE dans', CVES_DIR);
    console.log('Cela peut prendre quelques instants...\n');
    
    const startTime = Date.now();
    const cveFiles = listCveFiles(CVES_DIR);
    const endTime = Date.now();
    
    // Trier par ID CVE
    cveFiles.sort((a, b) => {
        const numA = parseInt(a.cveId.match(/CVE-2025-(\d+)/)?.[1] || '0');
        const numB = parseInt(b.cveId.match(/CVE-2025-(\d+)/)?.[1] || '0');
        return numA - numB;
    });
    
    // Créer l'objet index
    const index = {
        generatedAt: new Date().toISOString(),
        totalCves: cveFiles.length,
        cveIds: cveFiles.map(f => f.cveId),
        cvePaths: {}
    };
    
    // Créer un mapping CVE ID -> chemin
    cveFiles.forEach(file => {
        index.cvePaths[file.cveId] = file.path;
    });
    
    // Écrire le fichier index
    fs.writeFileSync(INDEX_FILE, JSON.stringify(index, null, 2), 'utf8');
    
    const duration = ((endTime - startTime) / 1000).toFixed(2);
    console.log(`✓ Index généré avec succès !`);
    console.log(`  - ${cveFiles.length} fichiers CVE trouvés`);
    console.log(`  - Fichier créé: ${INDEX_FILE}`);
    console.log(`  - Temps écoulé: ${duration}s`);
}

// Exécuter
try {
    generateIndex();
} catch (error) {
    console.error('Erreur lors de la génération de l\'index:', error);
    process.exit(1);
}

